name: Staging Build - Docker Image

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag, or commit SHA to build from'
        required: false
        default: 'main'
        type: string
  push:
    branches: [ staging, develop ]
  pull_request:
    branches: [ staging, develop ]

env:
  IMAGE_NAME: gateman-face-staging

jobs:
  build-only:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || github.ref }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Pull base image
      run: |
        echo "Pulling base image to ensure it's available..."
        docker pull ghcr.io/emekarr/gateman-face-base-image:latest

    - name: Build Docker image (no push)
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ${{ env.IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Validate build
      run: |
        echo "Validating Docker image..."
        docker images ${{ env.IMAGE_NAME }}:latest

        # Quick test to ensure the image was built correctly
        echo "Testing if image exists and can be inspected..."
        docker inspect ${{ env.IMAGE_NAME }}:latest > /dev/null

        echo "âœ… Docker image built successfully!"
        echo "Image details:"
        docker images ${{ env.IMAGE_NAME }}:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

    - name: Build information
      run: |
        echo "## Build Summary ðŸ“‹" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Ref:** ${{ github.event.inputs.ref || github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** ${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** âœ… Built successfully (not pushed)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Image Details ðŸ³" >> $GITHUB_STEP_SUMMARY
        docker images ${{ env.IMAGE_NAME }}:latest --format "- Size: {{.Size}}" >> $GITHUB_STEP_SUMMARY
